<app-admin-shell>
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="fw-bold text-dark">Seguimiento de prácticas</h2>
        <p class="text-secondary">Alta, edición y borrado de seguimientos</p>
      </div>
      <button class="btn btn-dark" (click)="openCreate()">Nuevo seguimiento</button>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <p class="text-secondary small m-0">Total registros</p>
          <h5 class="m-0">{{ total }}</h5>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-outline-secondary btn-sm" [disabled]="page <= 1 || loading" (click)="load(page - 1)">
            Anterior
          </button>
          <span class="text-secondary small">Página {{ page }} / {{ lastPage }}</span>
          <button class="btn btn-outline-secondary btn-sm" [disabled]="page >= lastPage || loading" (click)="load(page + 1)">
            Siguiente
          </button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="m-0">Listado de seguimientos</h6>
        <button class="btn btn-dark btn-sm" (click)="openCreate()">Nuevo seguimiento</button>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Título</th>
              <th>Alumno</th>
              <th>Empresa</th>
              <th>Profesor</th>
              <th>Curso</th>
              <th>Fechas</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!loading && seguimientos.length === 0">
              <td colspan="7" class="text-center text-secondary py-4">No hay seguimientos registrados.</td>
            </tr>
            <tr *ngFor="let seguimiento of seguimientos">
              <td>
                <div class="fw-semibold">{{ seguimiento.titulo }}</div>
                <small class="text-secondary">{{ seguimiento.estado || 'Sin estado' }}</small>
              </td>
              <td>{{ seguimiento.alumno?.name || seguimiento.user?.name || seguimiento.user_id }}</td>
              <td>{{ seguimiento.empresa?.nombre || seguimiento.empresa_id }}</td>
              <td>{{ seguimiento.profesor?.user?.name || seguimiento.profesor_id }}</td>
              <td>{{ seguimiento.curso_academico?.nombre || seguimiento.cursoAcademico?.nombre || seguimiento.curso_academico_id }}</td>
              <td>
                <div>{{ seguimiento.fecha_inicio }} → {{ seguimiento.fecha_fin }}</div>
                <small class="text-secondary">{{ seguimiento.horas_totales }} h</small>
              </td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-secondary me-2" (click)="openEdit(seguimiento)">Editar</button>
                <button class="btn btn-sm btn-outline-danger" (click)="remove(seguimiento)">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="alert alert-danger mt-3" *ngIf="errorMessage">{{ errorMessage }}</div>

    <app-modal-shared
      [open]="modalOpen"
      [title]="editingId ? 'Editar seguimiento' : 'Nuevo seguimiento'"
      primaryLabel="Guardar"
      secondaryLabel="Cancelar"
      (primary)="submit()"
      (secondary)="closeModal()"
      (backdrop)="closeModal()"
    >
      <form [formGroup]="form" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Empresa</label>
          <select class="form-select" formControlName="empresa_id">
            <option [ngValue]="null">Selecciona empresa</option>
            <option *ngFor="let empresa of empresas" [ngValue]="empresa.id">{{ empresa.nombre }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Profesor</label>
          <select class="form-select" formControlName="profesor_id">
            <option [ngValue]="null">Selecciona profesor</option>
            <option *ngFor="let profesor of profesores" [ngValue]="profesor.id">
              {{ profesor.user?.name || ('Profesor #' + profesor.id) }}
            </option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Curso académico</label>
          <select class="form-select" formControlName="curso_academico_id">
            <option [ngValue]="null">Selecciona curso</option>
            <option *ngFor="let curso of cursos" [ngValue]="curso.id">{{ curso.nombre }}</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Alumno (usuario)</label>
          <select class="form-select" formControlName="user_id">
            <option [ngValue]="null">Selecciona alumno</option>
            <option *ngFor="let user of usuarios" [ngValue]="user.id">{{ user.name }} ({{ user.email }})</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Título</label>
          <input class="form-control" formControlName="titulo" />
        </div>
        <div class="col-12">
          <label class="form-label">Descripción</label>
          <textarea class="form-control" rows="2" formControlName="descripcion"></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Fecha inicio</label>
          <input type="date" class="form-control" formControlName="fecha_inicio" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Fecha fin</label>
          <input type="date" class="form-control" formControlName="fecha_fin" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Horas totales</label>
          <input type="number" class="form-control" formControlName="horas_totales" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Estado</label>
          <input class="form-control" formControlName="estado" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Objetivos</label>
          <input class="form-control" formControlName="objetivos" />
        </div>
        <div class="col-12">
          <label class="form-label">Actividades</label>
          <textarea class="form-control" rows="2" formControlName="actividades"></textarea>
        </div>
      </form>
      <div class="text-danger small mt-2" *ngIf="errorMessage">{{ errorMessage }}</div>
      <div class="text-secondary small" *ngIf="saving">Guardando cambios...</div>
    </app-modal-shared>
  </div>
</app-admin-shell>
